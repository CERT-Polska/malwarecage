import React, {Component} from 'react';

import { ConfirmationModal } from "@malwarefront/ui";
import {FontAwesomeIcon} from '@fortawesome/react-fontawesome'
import {faTrash} from "@fortawesome/free-solid-svg-icons"
import api from "@malwarefront/api";

import QueryAddModal from "./QueryAddModal";


class QuickQuery extends Component {
    state = {
        queries: [],
        isAddModalOpen: false,
        isDeleteModalOpen: false,
        modalError: ""
    }

    getQueries = async () => {
        try {
            let response = await api.getQueries(this.props.type)
            this.setState({queries: response.data})
        } catch (error) {
            console.log(error)
        }
    }

    componentDidMount() {
        this.getQueries()
    }

    addQuickQuery = async (name) => {
        if (!this.props.query) {
            this.setState({modalError: "You can't save empty query"})
        } else {
            try {
                await api.addQuery(this.props.type , name, this.props.query)
                this.getQueries()
                this.setState({isAddModalOpen: false})
            } catch (error) {
                this.setState({modalError: error})
            }
        }
    }

    deleteQuery = async (id) => {
        await api.deleteQuery(id)
        this.setState({isDeleteModalOpen: false})
        this.getQueries()
    }

    handleError = (error) => {
        this.setState({modalError: error});
    }

    render() {
        let queryBadges = Object(this.state.queries).map((v) =>
                <span key={v.id} className="badge badge-info" style={{"cursor": "pointer"}}
                      data-toggle="tooltip"
                      title="Add a quick query to your search or click on the trash to delete it."
                      onClick={() => {this.props.submitQuery(v.query)}}>
                    {v.name}{" "}
                    <span data-toggle="tooltip"
                          title="Delete quick query."
                          onClick={(ev) => {
                              ev.preventDefault();
                              this.setState({isDeleteModalOpen: true})
                          }}>
                        <FontAwesomeIcon icon={faTrash} pull="right" size="md"/>
                    </span>
                    <ConfirmationModal buttonStyle="btn-success"
                               confirmText="Yes"
                               message="Are you sure you want to delete this quick query?"
                               isOpen={this.state.isDeleteModalOpen}
                               onRequestClose={() => this.setState({isDeleteModalOpen: false})}
                               onConfirm={(ev) => {
                                   ev.preventDefault();
                                   this.deleteQuery(v.id)
                               }}/>
                </span>

        )

        const newQuickQuery = <span className="badge badge-info" style={{"cursor": "pointer"}}
                                    data-toggle="tooltip"
                                    title="Save current search as quick query"
                                    onClick={(ev) => {ev.preventDefault(); this.setState({isAddModalOpen: true})}}>
                                    +
                                </span>

        return (
            <span>{queryBadges}{newQuickQuery}
            <QueryAddModal isOpen={this.state.isAddModalOpen}
                           error={this.state.modalError}
                           onError={this.handleError}
                           onSubmit={this.addQuickQuery}
                           onRequestModalClose={
                               () => this.setState({
                                   isAddModalOpen: false,
                                   modalError: "",
                               })
                                   }/></span>
        )
    }
}

export default QuickQuery;
