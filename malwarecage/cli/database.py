import click

from flask_migrate import upgrade

from malwarecage.core.capabilities import Capabilities
from malwarecage.core.config import app_config
from malwarecage.model import db, User, Group


def _is_database_initialized():
    return Group.query.count() > 0 and User.query.count() > 0


def _initialize(admin_password):
    """
    Creates initial objects in database
    """
    public_group = Group(name=Group.PUBLIC_GROUP_NAME, capabilities=[])
    db.session.add(public_group)

    everything_group = Group(name=Group.EVERYTHING_GROUP_NAME, capabilities=[Capabilities.access_all_objects])
    db.session.add(everything_group)

    admin_group = Group(name=app_config.malwarecage.admin_login, capabilities=Capabilities.all(), private=True)
    db.session.add(admin_group)

    admin_user = User(
        login=app_config.malwarecage.admin_login,
        email="admin@malwarecage.local",
        additional_info="Malwarecage built-in administrator account",
        groups=[admin_group, everything_group, public_group]
    )
    admin_user.reset_sessions()
    admin_user.set_password(admin_password)
    db.session.add(admin_user)
    db.session.commit()


def configure_database():
    upgrade()

    if _is_database_initialized():
        click.echo("[+] Database already initialized... skipping")
        return

    if app_config.malwarecage.admin_password:
        admin_password = app_config.malwarecage.admin_password
    else:
        while True:
            admin_password = click.prompt("Provide password for Malwarecage 'admin' account", hide_input=True)
            admin_repeat_password = click.prompt("Repeat password", hide_input=True)
            if admin_password == admin_repeat_password:
                break
            click.echo("[!] Passwords doesn't match", err=True)

    _initialize(admin_password)
