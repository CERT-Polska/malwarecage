import React, {Component} from 'react';
import AttributesAddModal from './AttributesAddModal';
import {FontAwesomeIcon} from '@fortawesome/react-fontawesome';
import api from "@malwarefront/api";
import { fromPlugin, Extendable } from "@malwarefront/extensions";
import { DataTable, ConfirmationModal } from "@malwarefront/ui";
import ActionCopyToClipboard from "./ActionCopyToClipboard";

let attributeRenderers = {}

for(let extraRenderers of fromPlugin("attributeRenderers")) {
    attributeRenderers = {...attributeRenderers, ...extraRenderers}
}

class DefaultAttributeRenderer extends Component {
    state = {
        collapsed: true,
        isAttributeDeleteModalOpen: false
    }

    get isCollapsible() {
        return this.props.values.length > 3
    }

    toggle() {
        this.setState({collapsed: !this.state.collapsed})
    }

    handleDeleteAttribute = async () => {
        try {
            await api.removeObjectMetakey(this.props.object.type, this.props.object.id, this.props.values[0].key);
            this.props.onUpdateAttributes();
        } catch (error) {
            console.log(error)
        }
    }

    render() {
        let visibleValues = this.props.values;
        if(this.state.collapsed)
            visibleValues = visibleValues.slice(0, 3);
        return (
            <tr key={this.props.label}>
                <th onClick={ev => {ev.preventDefault(); this.toggle()}}>
                    {
                        this.isCollapsible ?
                        <FontAwesomeIcon icon={this.state.collapsed ? "plus" : "minus"} size="sm"/>
                        : []
                    }&nbsp;
                    {this.props.label}
                    <span className="ml-2"
                          data-toggle="tooltip"
                          title="Remove attribute from object."
                          onClick={() => this.setState({isAttributeDeleteModalOpen: true})}>
                        <FontAwesomeIcon icon={"trash"}
                                         size="sm"
                                         style={{cursor: "pointer"}}/>
                    </span>
                </th>
                <td>
                    { visibleValues.map(attr => (
                        <div key={attr.value}>
                            {
                                attr.url 
                                ? <a href={attr.url}>{attr.value}</a>
                                : <span>{attr.value}</span>
                            }
                            <span className="ml-2">
                                <ActionCopyToClipboard text={attr.value} tooltipMessage="Copy value to clipboard"/>
                            </span>
                        </div>
                    ))}
                    { this.isCollapsible && this.state.collapsed
                      ? <span style={{color: "gray", fontWeight: "bold"}}>...</span>
                      : []
                    }
                </td>
                <ConfirmationModal buttonStyle="btn-danger"
                                   confirmText="Yes"
                                   cancelText="No"
                                   message="Are you sure to remove this attribute from this object?"
                                   isOpen={this.state.isAttributeDeleteModalOpen}
                                   onRequestClose={() => this.setState({isAttributeDeleteModalOpen: false})}
                                   onConfirm={(ev) => {
                                       ev.preventDefault();
                                       this.handleDeleteAttribute();
                                       this.setState({isAttributeDeleteModalOpen: false})
                                   }}/>
            </tr>
        )
    }
}

class ObjectAttributes extends Component {
    state = {}
    updateAttributes = async () => {
        if (typeof this.props.object.id === 'undefined')
            return;
        try {
            let response = await api.getObjectMetakeys(this.props.object.id)
            let aggregated = response.data.metakeys.reduce(
                (agg, m) => {
                    let label = m.label || m.key;
                    return {
                        ...agg,
                        [label]: [m].concat(agg[label] || []) 
                    }
                }, {}
            )
            this.setState({
                attributes: aggregated
            });
        } catch(error) {
            console.error(error);
            if(this.props.onError)
                this.props.onError(error);
        }
    }

    addAttribute = async (key, value) => {
        try {
            await api.addObjectMetakey(this.props.object.id, key, value)
            await this.updateAttributes();
            this.props.onRequestModalClose();
        } catch(error) {
            console.error(error);
            if(this.props.onError)
                this.props.onError(error);
        }
    }

    componentDidMount() {
        this.updateAttributes();
    }

    componentDidUpdate(prevProps) {
        if (prevProps && prevProps.object.id !== this.props.object.id)
            this.updateAttributes();
    }

    render() {
        if(!this.state.attributes)
            return [];
        return (
            <Extendable ident="attributesList" 
                        attributes={this.state.attributes}
                        onUpdateAttributes={this.updateAttributes}
                        object={this.props.object}>
                {
                    Object.keys(this.state.attributes).length > 0
                    ? <DataTable>
                        {
                            Object.keys(this.state.attributes)
                                .sort()
                                .map(label => {
                                    let values = this.state.attributes[label];
                                    let key = (values[0] && values[0].key);
                                    let Attribute = attributeRenderers[key] || DefaultAttributeRenderer;
                                    return <Attribute key={key} label={label} values={values}
                                                      object={this.props.object} onUpdateAttributes={this.updateAttributes}/>
                                })
                        }
                      </DataTable>
                    : <div className="card-body text-muted">No attributes to display</div>
                }
                <AttributesAddModal isOpen={this.props.isModalOpen}
                                    onRequestClose={this.props.onRequestModalClose}
                                    onAdd={this.addAttribute}/>
            </Extendable>
        )
    }
}

export default ObjectAttributes;
